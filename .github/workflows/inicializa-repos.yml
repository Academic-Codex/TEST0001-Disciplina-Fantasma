name: Inicializa repos

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Processar todos do registry ou somente um"
        required: true
        default: "all"
        type: choice
        options: ["all", "one"]

      org:
        description: "Org (usado quando mode=one)"
        required: false
        default: "academic-codex"

      repo:
        description: "Repo (usado quando mode=one)"
        required: false
        default: ""

      force:
        description: "Forçar re-publicar gh-pages mesmo se existir"
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  init:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1) Checkout do REPO CENTRAL (source of truth)
      # ------------------------------------------------------------
      - name: Checkout central repo
        uses: actions/checkout@v4
        with:
          path: central

      # ------------------------------------------------------------
      # 2) Setup Python
      # ------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ------------------------------------------------------------
      # 3) Dependências
      # ------------------------------------------------------------
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      # ------------------------------------------------------------
      # 4) Identidade Git (necessário para commits nos repos alvo)
      # ------------------------------------------------------------
      - name: Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Configure git auth
        run: |
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic $(printf x-access-token:${GH_TOKEN} | base64 -w0)"
        env:
          GH_TOKEN: ${{ secrets.GH_WORKFLOWS }}

      # ------------------------------------------------------------
      # 5) Inicializador (EXECUTA DENTRO DO CENTRAL)
      # ------------------------------------------------------------
      - name: Run initializer
        working-directory: central
        env:
          GH_TOKEN: ${{ secrets.GH_WORKFLOWS }}
          MODE: ${{ inputs.mode }}
          ONE_ORG: ${{ inputs.org }}
          ONE_REPO: ${{ inputs.repo }}
          FORCE: ${{ inputs.force }}
        run: |
          python .github/scripts/repo_initializer.py